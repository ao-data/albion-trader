const R = require('ramda');
const { bytesToGuid } = require('./bytes-to-guid');
const { mailTypes } = require('./enums');

const CSharpDateTimeToJS = ticks =>
    new Date(
        ticks / 10000 // 0.1us to 1ms
        - 62135596800000 // unix epoch in CSharp
    );

module.exports.parseMailInfo = R.pipe(
    R.omit(['0', '253', 'debugMessage']),
    R.mapObjIndexed((x, k) => R.map(y => ({ [k]: y }))(x)),
    R.values,
    R.converge(R.reduce(R.zipWith(R.merge)), [R.head, R.tail]),
    R.map(R.applySpec({
        Id: R.prop(1),
        senderId: R.pipe(R.prop(2), bytesToGuid),
        isGuild: R.prop(3),
        senderId: R.pipe(R.prop(4), bytesToGuid),
        location: R.prop(5),
        message_type: R.pipe(R.prop(6), R.prop(R.__, mailTypes)),
        isRead: R.prop(7), // fixme - needs an advanced merge strategy
        message_type_name: R.prop(8),
        dateTime: R.pipe(R.prop(9), CSharpDateTimeToJS),
    })),
    R.groupBy(R.prop("Id")),
    R.map(R.pipe(
        R.head, 
        R.omit(["Id"]),
    )),
);

const test = false
if (test) {
    const x = {
        type: 'OPERATION_RESPONSE',
        data:
        {
            '0': true,
            '1':
                [244655358,
                    244523892,
                    240922623,
                    240922594,
                    240269122,
                    239351209,
                    239318368,
                    239288190,
                    239286165,
                    239264027,
                    239263992,
                    239263079,
                    239258924,
                    239257406,
                    239257176,
                    239255580,
                    239251921,
                    239251350,
                    239250522,
                    239249229,
                    238854940,
                    238852838,
                    237332327,
                    237332098,
                    237300466,
                    237297310,
                    237294959,
                    237294863,
                    237294385,
                    237293704,
                    237292163,
                    237291753,
                    237289999,
                    237289142,
                    237287377,
                    237286776,
                    237283822,
                    237282805,
                    237281968,
                    237281434,
                    237281248,
                    237279989,
                    237277511,
                    237276427,
                    237275724],
            '2':
                [[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]],
            '3':
                [true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true,
                    true],
            '4':
                [[55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74],
                [55, 31, 251, 217, 111, 221, 44, 66, 142, 233, 201, 205, 123, 205, 52, 74]],
            '5':
                ['2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004',
                    '2004'],
            '6':
                [3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3,
                    3],
            '7':
                [false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    true,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    true,
                    true,
                    true,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    false,
                    true,
                    true,
                    true],
            '8':
                ['MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_SELLORDER_FINISHED',
                    'MARKETPLACE_BUYORDER_FINISHED'],
            '9':
                [636948238766062600,
                    636948182387820900,
                    636946298521475000,
                    636946298493035800,
                    636945928479972500,
                    636945555441626200,
                    636945538201925100,
                    636945519009877600,
                    636945480522869900,
                    636945466707037300,
                    636945466691300100,
                    636945466089738400,
                    636945463240483200,
                    636945462419237200,
                    636945462277218000,
                    636945461371495600,
                    636945458948332300,
                    636945458536037200,
                    636945457959527600,
                    636945457152268700,
                    636945205693988000,
                    636945204159879600,
                    636944600486160400,
                    636944600388991700,
                    636944586555052400,
                    636944585241588600,
                    636944584234810600,
                    636944584188532400,
                    636944583983740400,
                    636944583701298400,
                    636944583013709400,
                    636944582833974900,
                    636944582050261100,
                    636944581574707800,
                    636944580730839900,
                    636944580523427300,
                    636944579402968000,
                    636944578951018400,
                    636944578587793700,
                    636944578357911000,
                    636944578268228400,
                    636944577683172400,
                    636944576577290600,
                    636944576052222100,
                    636944575720193200],
            '253': 165,
            debugMessage: null
        }
    };
    module.exports.parseMailInfo(x.data); /*?*/
}
